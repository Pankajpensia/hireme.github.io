<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Storage and Realtime Database Example</title>
</head>
<body>

<h1>Firebase Storage and Realtime Database Example</h1>

<!-- Image Upload Form -->
<form id="imageUploadForm">
    <input type="file" id="imageInput" accept="image/*">
    <button type="button" id="uploadButton">Upload Image</button>
</form>

<!-- Display Uploaded Images -->
<div id="imageContainer" style="margin-top: 10px;">
    <!-- Images will be dynamically added here -->
</div>

<!-- Delete Options -->
<button type="button" id="deleteAllButton">Delete All Images</button>

<!-- Load JavaScript module -->
<script type="module">

document.querySelector("#uploadButton").addEventListener("click", uploadImage);
document.querySelector("#deleteAllButton").addEventListener("click", deleteAllImages);

// Import Firebase SDK modules
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.1/firebase-app.js';
import { getStorage, ref, listAll, getDownloadURL, uploadBytes, deleteObject } from 'https://www.gstatic.com/firebasejs/9.0.1/firebase-storage.js';
import { getDatabase, ref as dbRef, push, set, onChildAdded, remove } from 'https://www.gstatic.com/firebasejs/9.0.1/firebase-database.js';
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA9LG1iBZVkmRx2UCJE_CLcBNygw_4wX7k",
  authDomain: "hire-me-6f503.firebaseapp.com",
  databaseURL: "https://hire-me-6f503-default-rtdb.firebaseio.com",
  projectId: "hire-me-6f503",
  storageBucket: "hire-me-6f503.appspot.com",
  messagingSenderId: "468165791374",
  appId: "1:468165791374:web:909c4a28f36330b2c483df",
  measurementId: "G-4M1CK8TBL3"
};
// Initialize Firebase
const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const database = getDatabase(app);

// Get references to DOM elements
const imageInput = document.getElementById('imageInput');
const imageContainer = document.getElementById('imageContainer');

// Function to upload image to Firebase Storage and store data in Realtime Database
function uploadImage() {
    const file = imageInput.files[0];
    if (file) {
        // Create a reference to the file you want to upload
        const storageRef = ref(storage, 'images/' + file.name);

        // Upload file to Firebase Storage
        uploadBytes(storageRef, file).then((snapshot) => {
            console.log('Uploaded a file!');

            // Get download URL for the uploaded image
            getDownloadURL(snapshot.ref).then((downloadURL) => {
                // Store image data in Realtime Database
                const imageId = push(dbRef(database, 'images')).key;
                const imageData = {
                    imageId: imageId,
					imageName: file.name
                };

                // Set the image data in the database
                set(dbRef(database, 'images/' + imageId), imageData);

                // Refresh the displayed images
                displayImages();
            }).catch((error) => {
                console.error('Error getting download URL:', error);
            });
        }).catch((error) => {
            console.error('Error uploading file:', error);
        });
    } else {
        console.error('No file selected.');
    }
}

function displayImages() {
    imageContainer.innerHTML = ''; // Clear previous images
 onChildAdded(dbRef(database, 'images'), (snapshot) => {
        const imageData = snapshot.val();

    // List all files in the 'images' folder
    listAll(ref(storage, 'images')).then((result) => {
        result.items.forEach((item) => {
            // Get download URL for each file
            getDownloadURL(item).then((downloadURL) => {
                // Create image element and append to the container
                const imgElement = document.createElement('img');
                imgElement.src = downloadURL;
                imgElement.style.maxWidth = '150px';
                imgElement.style.maxHeight = '150px'; 
				const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete Image';
        deleteButton.addEventListener('click', () => deleteImage(imageData.imageId, imageData.imageName));

		
                imageContainer.appendChild(imgElement);
				imageContainer.appendChild(deleteButton);
            }).catch((error) => {
                console.error('Error getting download URL:', error);
            });
        });
    }).catch((error) => {
        console.error('Error listing files:', error);
    });
    });

}

// Function to delete a specific image by its ID
function deleteImage(imageId, imageName) {
    // Delete the corresponding image data from the Realtime Database
    remove(dbRef(database, 'images/' + imageId)).then(() => {
        console.log('Deleted the image data from the database!');
        // Refresh the displayed images
        displayImages();
    }).catch((error) => {
        console.error('Error deleting image data from the database:', error);
    });

    // Delete the image from Firebase Storage
    const storageRef = ref(storage, 'images/' + imageName);
    deleteObject(storageRef).then(() => {
        console.log('Deleted the file from storage!');
    }).catch((error) => {
        console.error('Error deleting file from storage:', error);
    });
}

// Function to delete all images
function deleteAllImages() {
    // Retrieve all image data from the Realtime Database
    listAll(dbRef(database, 'images')).then((result) => {
        result.items.forEach((item) => {
            // Get the image ID from the storage path
            const imageId = item.name.substring(item.name.lastIndexOf('/') + 1);

            // Delete the corresponding image data from the Realtime Database
            remove(dbRef(database, 'images/' + imageId)).catch((error) => {
                console.error('Error deleting image data from the database:', error);
            });

            // Delete each file from Firebase Storage
            deleteObject(item).catch((error) => {
                console.error('Error deleting file from storage:', error);
            });
        });
        console.log('Deleted all files and corresponding image data!');
        // Refresh the displayed images
        displayImages();
    }).catch((error) => {
        console.error('Error listing files:', error);
    });
}

// Display images when the page loads
displayImages();

</script>

</body>
</html>
